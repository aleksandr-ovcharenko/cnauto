{% extends "base.html" %}

{% block title %}–ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π | CN Auto{% endblock %}

{% block content %}
<div class="catalog-layout">
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <aside class="filters-sidebar">
        <form method="get">
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥—É -->
            <div class="filter-group">
                <h4>–ë—Ä–µ–Ω–¥</h4>
                <div class="facet-items collapsed">
                    {% for brand in brands %}
                    <label class="facet-item {% if loop.index > 5 %}hidden{% endif %}">
                        <input type="radio" name="brand" value="{{ brand.slug }}"
                               {% if request.args.get('brand') == brand.slug %}checked{% endif %}>
                        {{ brand.name }}
                    </label>
                    {% endfor %}
                </div>
                {% if brands|length > 5 %}
                <button type="button" class="facet-toggle" data-target="brand">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
                {% endif %}
            </div>

            <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç—Ä–∞–Ω–µ -->
            <div class="filter-group">
                <h4>–°—Ç—Ä–∞–Ω–∞</h4>
                <div class="facet-items collapsed">
                    {% for country in countries %}
                    <label class="facet-item {% if loop.index > 5 %}hidden{% endif %}">
                        <input type="radio" name="country" value="{{ country.name }}"
                               {% if request.args.get('country') == country.name %}checked{% endif %}>
                        {{ country.name }}
                    </label>
                    {% endfor %}
                </div>
                {% if countries|length > 5 %}
                <button type="button" class="facet-toggle" data-target="country">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
                {% endif %}
            </div>

            <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É -->
            <div class="filter-group">
                <h4>–¢–∏–ø –∞–≤—Ç–æ</h4>
                <div class="facet-items collapsed">
                    {% for car_type in car_types %}
                    <label class="facet-item {% if loop.index > 5 %}hidden{% endif %}">
                        <input type="checkbox" name="type" value="{{ car_type.slug }}" onchange="this.form.submit()"
                               {% if car_type.slug in request.args.getlist('type') %}checked{% endif %}>
                        {% if car_type.icon %}
                        <img src="{{ url_for('static', filename='images/types/' + car_type.icon) }}"
                             alt="{{ car_type.name }}" class="type-icon">
                        {% endif %}
                        {{ car_type.name }}
                    </label>
                    {% endfor %}
                </div>
                {% if car_types|length > 5 %}
                <button type="button" class="facet-toggle" data-target="type">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>
                {% endif %}
            </div>

            <div class="filter-buttons">
                <button type="submit" class="btn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <a href="{{ url_for('catalog') }}" class="btn btn-reset">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</a>

                {% if request.args.getlist('type') %}
                <a href="{{ reset_type_url }}" class="btn btn-reset">
                    –°–±—Ä–æ—Å–∏—Ç—å —Ç–∏–ø –∞–≤—Ç–æ
                </a>
                {% endif %}
            </div>
        </form>
    </aside>

    <!-- –ö–∞—Ç–∞–ª–æ–≥ –∞–≤—Ç–æ -->
    <section class="catalog-results">
        <div class="cars-grid">
            {% for car in cars %}
            <div class="car-card">
                <div class="car-card__image-wrapper">
                    <img class="car-card__image"
                         src="{{ car.image_url }}"
                         alt="{{ car.model }}"/>
                </div>

                <div class="car-card__content">
                    <div class="car-card__header">
                        <span class="car-card__tag">–ù–æ–≤–∞—è</span>
                        {% if car.in_stock %}
                        <span class="car-card__status in-stock">–í –Ω–∞–ª–∏—á–∏–∏</span>
                        {% else %}
                        <span class="car-card__status pre-order">–ü–æ–¥ –∑–∞–∫–∞–∑</span>
                        {% endif %}
                    </div>

                    <div class="car-card__brand">
                        {% if car.brand %}
                        {% if car.brand.logo %}
                        <img src="{{ url_for('static', filename='images/brands/' + car.brand.logo) }}"
                             alt="{{ car.brand.name }}" height="30">
                        {% else %}
                        <span>{{ car.brand.name }}</span>
                        {% endif %}
                        {% endif %}
                        <h3 class="car-card__title">{{ car.model }}</h3>
                    </div>

                    <div class="car-card__price">{{ car.price | round }} ‚ÇΩ</div>

                    <ul class="car-card__specs">
                        {% if car.engine %}
                        <li>‚ö° {{ car.engine }}</li>
                        {% endif %}
                        {% if car.car_type %}
                        <li>üöó {{ car.car_type.name }}</li>
                        {% endif %}
                        {% if car.year %}
                        <li>üìÖ {{ car.year }}</li>
                        {% endif %}
                        {% if car.mileage %}
                        <li>üõ£ {{ car.mileage }} –∫–º</li>
                        {% endif %}
                    </ul>

                    <a href="{{ url_for('car_details', car_id=car.id) }}" class="btn-full">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
</div>
<div class="quick-view-modal" id="quickViewModal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="modal-inner">
            <div class="modal-image">
                <img id="modalCarImage" src="" alt="car">
            </div>
            <div class="modal-info">
                <h2 id="modalCarTitle"></h2>
                <p id="modalCarType"></p>
                <p><strong>–¶–µ–Ω–∞:</strong> <span id="modalCarPrice"></span></p>
                <a id="modalCarLink" href="#" class="btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
            </div>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById("quickViewModal");
    const closeModal = document.querySelector(".close-modal");

    document.querySelectorAll(".quick-view-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            const card = btn.closest(".car-card");

            if (!card) {
                console.warn("üö´ –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –º–∞—à–∏–Ω—ã");
                return;
            }

            const titleEl = card.querySelector(".car-card__title");
            const priceEl = card.querySelector(".car-card__price");
            const typeEl = card.querySelector(".car-card__specs li:nth-child(2)");
            const imgEl = card.querySelector(".car-card__image");
            const linkEl = card.querySelector("a.btn-full");

            if (!titleEl || !priceEl || !imgEl || !linkEl) {
                console.warn("‚ùå –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∫–∞—Ä—Ç–æ—á–∫–µ", card);
                return;
            }

            document.getElementById("modalCarTitle").innerText = titleEl.innerText;
            document.getElementById("modalCarType").innerText = typeEl?.innerText || '‚Äî';
            document.getElementById("modalCarPrice").innerText = priceEl.innerText;
            document.getElementById("modalCarImage").src = imgEl.src;
            document.getElementById("modalCarLink").href = linkEl.href;

            modal.style.display = "block";
        });
    });

    closeModal.addEventListener("click", () => {
        modal.style.display = "none";
    });

    window.addEventListener("click", function (e) {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
</script>

{% endblock %}
