{% extends 'base.html' %}

{% block title %}{{ car.brand.name }} {{ car.model }}{% if car.modification %} {{ car.modification }}{% endif %}{% if car.trim %} {{ car.trim }}{% endif %} ‚Äî CN-Auto{% endblock %}

{% block content %}
<section class="product-detail">
    <div class="product-media">
        <!-- –ü—Ä–µ–≤—å—é—à–∫–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ —Å–ª–µ–≤–∞ -->
        <div class="product-thumbs">
            {% set thumbs = [car.image_url] + (car.gallery_images | map(attribute='url') | reject('equalto', car.image_url) | list) %}
            {% for thumb_url in thumbs %}
            <img src="{{ thumb_url | thumb_url(300) }}" data-full="{{ thumb_url }}" alt="–§–æ—Ç–æ {{ loop.index }}" class="car-thumb">
            {% endfor %}
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ -->
        <div class="product-image">
            <img class="main-image" src="{{ car.image_url }}" alt="{{ car.model }}">
        </div>
    </div>

    <div class="product-right">
        <h1 class="product-title">{{ car.brand.name }} {{ car.model }}{% if car.modification %} {{ car.modification }}{% endif %}{% if car.trim %} {{ car.trim }}{% endif %}</h1>
        <p class="product-meta">
            –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: <strong>{{ car.brand.name }}</strong> |
            –¢–∏–ø: <strong>{{ car.car_type.name }}</strong> |
            –ú–æ–¥–µ–ª—å: <strong>{{ car.model }}{% if car.modification %} {{ car.modification }}{% endif %}{% if car.trim %} {{ car.trim }}{% endif %}</strong>
        </p>

        <div class="product-config">
            <label><strong>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—é</strong></label>
            <div class="select-box">TOP</div>

            <label><strong>–ì–∞—Ä–∞–Ω—Ç–∏—è</strong></label>
            <div class="warranty-options">
                <label><input type="radio" name="warranty" checked> –ë–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–∏ <span>+ 0 ‚ÇΩ</span></label><br>
                <label><input type="radio" name="warranty"> –° –≥–∞—Ä–∞–Ω—Ç–∏–µ–π <span>+ 106 710 ‚ÇΩ</span></label>
            </div>
        </div>

        <div class="product-price-section">
            <span class="stock-tag pre-order">–ü–æ–¥ –∑–∞–∫–∞–∑</span>
            <div class="price">
                {{ car.price | format_currency(car.currency) }}
            </div>

            <div class="product-actions">
                <a href="#" class="btn">–ó–ê–ö–ê–ó–ê–¢–¨</a>
                <button class="icon-btn">üìå</button>
                <button class="icon-btn">üîÅ</button>
            </div>
        </div>
    </div>

    <div class="product-specs-icons">
        <div class="spec">
            ‚ö° <strong>–î–≤–∏–≥–∞—Ç–µ–ª—å:</strong> {{ car.engine or "‚Äî" }}
        </div>
        <div class="spec">
            üîã <strong>–û–±—ä–µ–º –±–∞—Ç–∞—Ä–µ–∏:</strong> {{ car.battery or "2 –∫–í—Ç‚ãÖ—á" }}
        </div>
        <div class="spec">
            üöó <strong>–ü—Ä–∏–≤–æ–¥:</strong> –ø–æ–ª–Ω—ã–π
        </div>
        <div class="spec">
            üõ£ <strong>–ó–∞–ø–∞—Å —Ö–æ–¥–∞:</strong> –¥–æ 1100 –∫–º
        </div>
        <div class="spec">
            ‚öôÔ∏è <strong>–ö–æ—Ä–æ–±–∫–∞:</strong> –û–¥–Ω–æ—Å—Ç—É–ø–µ–Ω—á–∞—Ç–∞—è
        </div>
        <div class="spec">
            ü™ë <strong>–°–∞–ª–æ–Ω:</strong> –ò—Å–∫. –∫–æ–∂–∞ + –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–∞—è –∫–æ–∂–∞
        </div>
        <div class="spec">
            üïí <strong>–î–æ 100 –∫–º/—á:</strong> 8 —Å–µ–∫.
        </div>
        <div class="spec">
            üîÅ <strong>–ö—Ä—É—Ç—è—â–∏–π –º–æ–º–µ–Ω—Ç:</strong> 250/1500‚Äì2500
        </div>
    </div>
</section>

{% endblock %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.price').forEach(function(el) {
        const locale = el.getAttribute('data-locale');
        const currency = el.getAttribute('data-currency');
        const rawText = el.textContent.trim();
        // Improved regex to extract number regardless of currency symbols
        const match = rawText.match(/[^0-9]*([0-9.,\s]+).*/);
        if (!locale || !currency || !match) {
            console.warn('Price formatting skipped:', { locale, currency, rawText });
            return;
        }
        let num = match[1];
        num = num.replace(/\s/g, '').replace(',', '.');
        const value = parseFloat(num);
        if (isNaN(value)) {
            console.warn('Could not parse price value:', { num, rawText });
            return;
        }
        try {
            el.textContent = new Intl.NumberFormat(locale, { style: 'currency', currency: currency }).format(value);
        } catch (e) {
            console.error('Formatting error:', e);
            el.textContent = value.toLocaleString(locale) + ' ' + currency;
        }
    });
});
</script>
